{% load i18n %}
<form hx-post="{% if item %}{% url 'backoffice:item_edit' item.pk %}{% else %}{% url 'backoffice:item_create' %}{% endif %}"
      hx-target="this" 
      hx-swap="outerHTML"
      class="bg-white">
    {% csrf_token %}

    <div class="p-6 pb-12">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">
            {% if item %}Editar Pregunta{% else %}Crear Nueva Pregunta{% endif %}
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="id_item_type" class="block text-sm font-medium text-gray-700">
                    Tipo de Pregunta
                </label>
                <select name="item_type" id="id_item_type"
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    {% for value, text in item_types %}
                        <option value="{{ value }}" {% if item.item_type == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="id_difficulty" class="block text-sm font-medium text-gray-700">
                    Dificultad
                </label>
                <select name="difficulty" id="id_difficulty"
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="1" {% if item.difficulty == 1 %}selected{% endif %}>Fácil</option>
                    <option value="2" {% if item.difficulty == 2 %}selected{% endif %}>Media</option>
                    <option value="3" {% if item.difficulty == 3 %}selected{% endif %}>Difícil</option>
                </select>
            </div>
        </div>

        <div>
            <label for="id_stem" class="block text-sm font-medium text-gray-700">
                Enunciado (Pregunta)
            </label>
            <textarea name="stem" id="id_stem" rows="4"
                      class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                      required>{{ item.stem|default_if_none:'' }}</textarea>
        </div>

        <div id="mc_options_container" class="space-y-3 pt-4 border-t mt-4">
            <h4 class="font-medium text-gray-800">Opciones (Múltiple Choice)</h4>
            <div>
                <label for="id_correct_answer" class="block text-sm font-medium text-green-700">
                    Respuesta Correcta
                </label>
                <input type="text" name="correct_answer" id="id_correct_answer"
                       value="{{ correct_answer_text|default_if_none:'' }}"
                       class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
            </div>

            <div>
                <label class="block text-sm font-medium text-red-700">
                    Distractores (Incorrectas)
                </label>
                <div class="space-y-2 mt-1" id="distractors-list">
                    {% for distractor in distractors_list %}
                    <input type="text" name="distractors" value="{{ distractor }}"
                           class="block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                           placeholder="Distractor {{ forloop.counter }}">
                    {% endfor %}
                </div>
            </div>

            <div id="ai-distractors-feedback" class="text-red-600 text-sm"></div>
            <button type="button" 
                    hx-post="{% url 'backoffice:ai_generate_distractors' %}"
                    hx-include="closest form"
                    hx-target="#distractors-list"
                    hx-swap="innerHTML"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none">
                Generar Distractores con IA ✨
            </button>
        </div>
    </div>

    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="submit"
                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
            Guardar
        </button>
        <button type="button" 
                @click="modalOpen = false"
                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
            Cancelar
        </button>
    </div>
</form>

<script>
    (function() {
        var itemTypeSelect = document.getElementById('id_item_type');
        var mcOptionsContainer = document.getElementById('mc_options_container');
        function toggleMcOptions() {
            if (!itemTypeSelect || !mcOptionsContainer) return;
            mcOptionsContainer.style.display = (itemTypeSelect.value === 'MC') ? 'block' : 'none';
        }
        toggleMcOptions();
        itemTypeSelect.addEventListener('change', toggleMcOptions);
    })();
</script>
