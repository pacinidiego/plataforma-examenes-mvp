<form hx-post="{% if item %}{% url 'backoffice:item_edit' item.pk %}{% else %}{% url 'backoffice:item_create' %}{% endif %}"
      x-data="{ itemType: '{{ item.item_type|default:'MC' }}' }">

    <div class="p-6 bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
        
        <h3 class="text-2xl font-semibold text-white mb-4">
            {% if item %}
                Editar Ítem (Pregunta)
            {% else %}
                Crear Nuevo Ítem (Pregunta)
            {% endif %}
        </h3>
        
        {% csrf_token %}

        <div class="mb-4">
            <label for="id_item_type" class="block text-sm font-medium text-gray-300">Tipo de Ítem</label>
            <select name="item_type" id="id_item_type" 
                    x-model="itemType"
                    class="w-full mt-1 bg-gray-700 text-white border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                {% for value, label in item_types %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-4">
            <label for="id_stem" class="block text-sm font-medium text-gray-300">Enunciado (Stem)</label>
            <textarea name="stem" id="id_stem" rows="4" required
                      class="w-full mt-1 bg-gray-700 text-white border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">{{ item.stem|default:'' }}</textarea>
        </div>

        <div x-show="itemType === 'MC'" class="space-y-4 p-4 border border-gray-700 rounded-md">
            
            {% if not item %}
            <p class="text-sm text-yellow-300">
                <i class="fas fa-lightbulb mr-1"></i> Escribe la respuesta correcta y presiona "Generar Distractores" para que la IA te ayude.
            </p>
            {% endif %}
            
            <div>
                <label for="id_correct_answer" class="block text-sm font-medium text-green-400">Respuesta Correcta</label>
                <input type="text" name="correct_answer" id="id_correct_answer"
                       value="{{ correct_answer_text|default:'' }}"
                       class="w-full mt-1 bg-gray-700 text-white border-green-500 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
            </div>

            {% if not item %}
            <div>
                <button type="button" 
                        class="w-full px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-md shadow-sm hover:bg-purple-700 focus:outline-none"
                        hx-post="{% url 'backoffice:ai_generate_distractors' %}"
                        hx-include="[name='stem'], [name='correct_answer']"
                        hx-target="#distractors-list"
                        hx-swap="innerHTML"
                        hx-indicator="#ai-spinner"
                        hx-on:htmx:afterRequest="event.stopPropagation()">
                    
                    <span class="htmx-indicator" id="ai-spinner">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generando...
                    </span>
                    <span class="no-indicator">
                        ✨ Generar Distractores (IA)
                    </span>
                </button>
            </div>
            {% endif %}
            
            <div id="distractors-list" class="space-y-2">
                <label class="block text-sm font-medium text-red-400">Opciones Incorrectas (Distractores)</label>
                
                {% for distractor in distractors_list %}
                <input type="text" name="distractors" 
                       value="{{ distractor|default:'' }}"
                       class="w-full mt-1 bg-gray-700 text-white border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                {% endfor %}

            </div>

        </div>
        <div class="mb-4 mt-4">
            <label for="id_difficulty" class="block text-sm font-medium text-gray-300">Dificultad (1-5)</label>
            <input type="number" name="difficulty" id="id_difficulty" 
                   value="{{ item.difficulty|default:1 }}" 
                   min="1" max="5"
                   class="w-full mt-1 bg-gray-700 text-white border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="flex justify-end space-x-3 mt-6">
            <button type="button" 
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"
                    x-on:click="showModal = false"> Cancelar
            </button>
            <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                {% if item %}
                    Guardar Cambios
                {% else %}
                    Guardar Ítem
                {% endif %}
            </button>
        </div>
    </div>
</form>
