<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Plataforma de Exámenes{% endblock %}</title>
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-full" 
      x-data="{ 
          modalOpen: false, 
          modalContent: 'Cargando...' 
      }"
      
      @htmx:after-swap="
          if ($event.detail.target.id === 'modal-content-form') {
              modalOpen = true;
          }
          // Chequeo seguro para redirecciones (ej. al borrar)
          if ($event.detail.xhr && $event.detail.xhr.getResponseHeader('HX-Redirect')) {
              if ($event.detail.xhr.getResponseHeader('HX-Redirect').includes('dashboard')) {
                  modalOpen = false;
              }
          }
      "
      @htmx:before-swap="
          // Chequeo seguro para el botón 'Cancelar' del modal
          if ($event.detail.target && $event.detail.target.id === 'modal-backdrop') {
              modalOpen = false;
              $event.detail.shouldSwap = false;
          }
      ">

    {% csrf_token %}
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = document.querySelector('[name="csrfmiddlewaretoken"]').value;
        })
    </script>

    <div>
        <main class="py-10">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div x-show="modalOpen" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         aria-labelledby="modal-title" role="dialog" aria-modal="true" style="display: none;">
        
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            
            <div @click="modalOpen = false" 
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="modalOpen"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                
                <div id="modal-content-form">
                    {{ modalContent|safe }}
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal-backdrop"></div>
</body>
</html>
