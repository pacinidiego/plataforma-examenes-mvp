{% extends "base.html" %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="h-full flex items-center justify-center bg-gray-100 p-4" x-data="techCheck()">

    <div class="w-full max-w-6xl bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col max-h-[95vh] border border-gray-200">
        
        <header class="bg-white border-b border-gray-100 p-6 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-50 p-2 rounded-lg text-indigo-600">
                    <svg x-show="step===1" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <svg x-show="step===2" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0c0 .883.393 1.627 1 2.188V19.5a.5.5 0 01-1 0V8.188A2.997 2.997 0 0110 6z"></path></svg>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-gray-800">Verificaci√≥n de Ingreso</h1>
                    <p class="text-sm text-gray-500" x-text="step === 1 ? 'Paso 1: Hardware' : 'Paso 2: Biometr√≠a e Identidad'"></p>
                </div>
            </div>
            <div x-show="isLoadingModels" class="text-xs text-blue-600 bg-blue-50 px-3 py-1 rounded-full animate-pulse border border-blue-200">
                üß† Cargando IA...
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full items-start">
                
                <div class="lg:col-span-7 flex flex-col gap-5">
                    
                    <div class="relative bg-gray-900 rounded-2xl overflow-hidden aspect-video shadow-sm border-4 transition-all duration-300 group"
                         :class="videoBorderClass">
                        
                        <video id="videoInput" x-ref="videoElement" autoplay playsinline muted 
                               class="w-full h-full object-cover transform transition-transform duration-500"
                               :class="step === 1 ? 'scale-x-[-1]' : 'scale-x-100'"></video>
                        
                        <div x-show="step === 2 && !isScanning" class="absolute top-2 left-2 px-2 py-1 rounded text-xs font-bold text-white transition-colors z-10"
                             :class="checks.face ? 'bg-green-600' : 'bg-red-600'">
                             <span x-text="checks.face ? 'ROSTRO DETECTADO ‚úÖ' : 'NO SE DETECTA ROSTRO ‚ùå'"></span>
                        </div>

                        <canvas x-ref="canvas" class="hidden"></canvas>

                        <div x-show="step === 2" x-transition class="absolute inset-0 pointer-events-none flex items-center justify-center">
                            <div class="w-3/5 h-3/5 border-2 border-white/50 rounded-lg relative overflow-hidden bg-white/10 backdrop-blur-sm">
                                <div class="absolute top-2 left-0 w-full text-center text-white text-xs font-bold bg-black/50 py-1">ENCUADRE SU DNI AQU√ç</div>
                                <div class="scan-overlay" x-show="isScanning"></div>
                            </div>
                        </div>
                    </div>

                    <div x-show="step === 1" class="bg-gray-50 pl-4 pr-5 py-3 rounded-xl border border-gray-200 flex items-center gap-4">
                         <div class="bg-white p-2 rounded-full text-gray-400 shadow-sm border border-gray-100 shrink-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                         </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-end mb-1.5">
                                <span class="text-xs font-bold text-gray-700">Micr√≥fono</span>
                                <span class="text-xs font-mono text-gray-500" x-show="checks.audio">Detectado</span>
                                <span class="text-xs font-mono text-orange-500 animate-pulse" x-show="!checks.audio">Habla para probar...</span>
                            </div>
                            <div class="flex gap-0.5 h-3">
                                <template x-for="i in 20">
                                    <div class="flex-1 rounded-sm transition-all duration-75"
                                         :class="(audioLevel / 5) > i ? 'bg-green-500' : 'bg-gray-200'"></div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div x-show="step === 2" class="flex justify-center flex-col items-center gap-2">
                        <button @click="scanDNI()" 
                                :disabled="isScanning || checks.dni"
                                class="px-6 py-3 rounded-lg font-bold text-white shadow-lg transition-all flex items-center gap-2"
                                :class="checks.dni ? 'bg-green-600 cursor-default' : 'bg-indigo-600 hover:bg-indigo-700 hover:-translate-y-1'">
                            
                            <span x-show="!isScanning && !checks.dni">üì∏ Capturar DNI</span>
                            <span x-show="isScanning">Validando con IA...</span>
                            <span x-show="checks.dni">Identidad Confirmada</span>
                        </button>
                        <p class="text-xs text-gray-500" x-show="!checks.dni">Aseg√∫rate de que haya buena luz y el texto sea legible.</p>
                    </div>
                </div>

                <div class="lg:col-span-5 flex flex-col h-full justify-center py-4 bg-gray-50/50 rounded-2xl px-6 border border-gray-100">
                    <h3 class="text-base font-bold text-gray-800 mb-6 uppercase tracking-wider">Estado del Proceso</h3>
                    
                    <div class="space-y-3 flex-1">
                        <div class="flex items-start p-4 bg-white rounded-xl border-2 transition-all duration-300 shadow-sm"
                             :class="checks.audio ? 'border-green-500 shadow-green-50' : 'border-gray-100'">
                             <div class="flex-1 flex justify-between items-center">
                                <h4 class="font-bold text-gray-900">Micr√≥fono</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full" :class="checks.audio ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" x-text="checks.audio ? 'OK' : 'Pendiente'"></span>
                            </div>
                        </div>
                        
                        <div class="flex items-start p-4 bg-white rounded-xl border-2 transition-all duration-300 shadow-sm"
                             :class="checks.network ? 'border-green-500 shadow-green-50' : 'border-gray-100'">
                             <div class="flex-1 flex justify-between items-center">
                                <h4 class="font-bold text-gray-900">Conexi√≥n</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full" :class="checks.network ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" x-text="checks.network ? 'OK' : '...'"></span>
                            </div>
                        </div>
                        
                        <div class="flex items-start p-4 bg-white rounded-xl border-2 transition-all duration-300 shadow-sm"
                             :class="checks.camera ? 'border-green-500 shadow-green-50' : 'border-gray-100'">
                             <div class="flex-1 flex justify-between items-center">
                                <h4 class="font-bold text-gray-900">C√°mara</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full" :class="checks.camera ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" x-text="checks.camera ? 'OK' : 'Pendiente'"></span>
                            </div>
                        </div>
                        
                        <div x-show="step === 2" class="flex items-start p-4 bg-white rounded-xl border-2 transition-all duration-300 shadow-sm"
                             :class="checks.face ? 'border-green-500 shadow-green-50' : 'border-red-300 bg-red-50 animate-pulse'">
                             <div class="flex-1 flex justify-between items-center">
                                <h4 class="font-bold text-gray-900">Presencia (Rostro)</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full" 
                                      :class="checks.face ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" 
                                      x-text="checks.face ? 'DETECTADO' : 'NO DETECTADO'"></span>
                            </div>
                        </div>

                        <div class="flex items-start p-4 bg-white rounded-xl border-2 transition-all duration-300 shadow-sm"
                             :class="checks.dni ? 'border-green-500 shadow-green-50' : (step === 2 ? 'border-indigo-400 ring-2 ring-indigo-100' : 'border-gray-100 opacity-60')">
                             <div class="flex-1">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-bold text-gray-900">Identidad (DNI)</h4>
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full" 
                                          :class="checks.dni ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" 
                                          x-text="checks.dni ? 'VALIDADO' : 'Requerido'"></span>
                                </div>
                                <p class="text-xs text-red-500 mt-1" x-show="errorMessage && !checks.dni" x-text="errorMessage"></p>
                                
                                <div x-show="checks.dni && !checks.face" class="mt-2 p-2 bg-blue-50 rounded border border-blue-100 animate-pulse">
                                    <p class="text-xs text-blue-700 font-bold flex items-center gap-2">
                                        ‚úÖ DNI Correcto.
                                    </p>
                                    <p class="text-xs text-blue-600 mt-1">
                                        Ahora retira el documento y muestra tu rostro para habilitar el bot√≥n.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button @click="step = 2" 
                                x-show="step === 1"
                                :disabled="!allHardwarePassed"
                                class="w-full py-4 rounded-xl font-bold text-lg text-center transition-all shadow-sm flex items-center justify-center gap-3"
                                :class="allHardwarePassed ? 'bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-md cursor-pointer' : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                            <span>Siguiente: Validar Identidad</span>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        </button>

                        <button @click="enterExam()"
                           x-show="step === 2"
                           :disabled="!checks.dni || !checks.face"
                           class="block w-full py-4 rounded-xl font-bold text-lg text-center transition-all shadow-sm flex items-center justify-center gap-3 relative overflow-hidden group"
                           :class="(checks.dni && checks.face) ? 'bg-green-600 text-white hover:bg-green-700 hover:shadow-md cursor-pointer' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                            
                            <span x-text="(checks.dni && checks.face) ? 'INGRESAR AL EXAMEN' : 'COMPLETE REQUISITOS'"></span>
                            
                            <svg x-show="checks.dni && checks.face" class="w-6 h-6 animate-bounce-x" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </button>
                        
                        <p class="text-center text-xs text-gray-400 mt-2" x-show="step === 2 && (!checks.dni || !checks.face)">
                            <span x-show="!checks.dni">Valida tu DNI. </span>
                            <span x-show="!checks.face" class="text-red-500 font-bold">Enfoca tu rostro.</span>
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
    function techCheck() {
        return {
            step: 1,
            checks: { camera: false, audio: false, network: true, dni: false, face: false },
            audioLevel: 0,
            isScanning: false,
            isEntering: false,
            isLoadingModels: true,
            errorMessage: '',
            detectionInterval: null,
            
            get allHardwarePassed() {
                return this.checks.camera && this.checks.audio && this.checks.network;
            },

            get videoBorderClass() {
                if (this.step === 1) return 'border-gray-300';
                return this.checks.face ? 'border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.3)]' : 'border-red-500';
            },

            async init() {
                await this.loadModels();
                await this.startCamera();
            },

            async loadModels() {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                try {
                    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                    this.isLoadingModels = false;
                } catch (error) {
                    alert("No se pudieron cargar los modelos de IA.");
                }
            },

            async startCamera() {
                const video = this.$refs.videoElement;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: { width: { ideal: 1280 }, height: { ideal: 720 } } 
                    });
                    video.srcObject = stream;
                    this.checks.camera = true; 
                    this.setupAudio(stream);
                    video.onplay = () => { this.startDetection(); };
                } catch (err) {
                    this.checks.camera = false;
                    alert("Error: No se pudo acceder a la c√°mara.");
                }
            },

            startDetection() {
                const video = this.$refs.videoElement;
                if (this.detectionInterval) clearInterval(this.detectionInterval);
                this.detectionInterval = setInterval(async () => {
                    if (video.paused || video.ended || !this.checks.camera) return;
                    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                    const detections = await faceapi.detectSingleFace(video, options);
                    this.checks.face = !!detections;
                }, 500);
            },

            setupAudio(stream) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                scriptProcessor.onaudioprocess = () => {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;
                    for (let i = 0; i < array.length; i++) values += array[i];
                    const average = values / array.length;
                    this.audioLevel = Math.min(100, Math.round(average * 2));
                    if (average > 10) this.checks.audio = true;
                };
            },

            async scanDNI() {
                if (this.isScanning) return;
                this.isScanning = true;
                this.errorMessage = '';
                const video = this.$refs.videoElement;
                const canvas = this.$refs.canvas;
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.9);

                try {
                    const url = "{% url 'runner:validate_dni' attempt.id %}";
                    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrf},
                        body: JSON.stringify({ image: imageData })
                    });
                    const result = await response.json();
                    if (result.success) {
                        this.checks.dni = true;
                        this.errorMessage = '';
                    } else {
                        this.checks.dni = false;
                        this.errorMessage = result.message;
                    }
                } catch (error) {
                    this.errorMessage = "Error de conexi√≥n.";
                } finally {
                    this.isScanning = false;
                }
            },

            async enterExam() {
                if (this.isEntering) return;
                this.isEntering = true;
                
                // 1. Capturar foto actual para referencia
                const video = this.$refs.videoElement;
                const canvas = this.$refs.canvas;
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const faceImage = canvas.toDataURL('image/jpeg', 0.9);
                
                try {
                    // 2. Enviar al servidor como 'reference_face'
                    const url = "{% url 'runner:register_biometrics' attempt.id %}";
                    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrf},
                        body: JSON.stringify({ reference_face: faceImage })
                    });
                    
                    // 3. Redirigir DIRECTO al examen (Saltando Gate)
                    window.location.href = "{% url 'runner:exam_runner' access_code=exam.access_code attempt_id=attempt.id %}";
                    
                } catch (e) {
                    console.error("Error al ingresar:", e);
                    alert("Hubo un error al ingresar. Intenta nuevamente.");
                    this.isEntering = false;
                }
            }
        }
    }
</script>

<style>
    [x-cloak] { display: none !important; }
    .scan-overlay {
        background: linear-gradient(to bottom, transparent, rgba(79, 70, 229, 0.4), transparent);
        position: absolute;
        width: 100%;
        height: 20%;
        animation: scanning 2s linear infinite;
        border-bottom: 2px solid #4f46e5;
    }
    @keyframes scanning {
        0% { top: -20%; }
        100% { top: 120%; }
    }
    .animate-bounce-x {
        animation: bounce-x 1s infinite;
    }
    @keyframes bounce-x {
        0%, 100% { transform: translateX(0); }
        50% { transform: translateX(25%); }
    }
</style>
{% endblock %}
