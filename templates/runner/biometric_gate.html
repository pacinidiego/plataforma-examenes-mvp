{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4" x-data="biometricScanner()">
    
    <input type="hidden" id="expected_dni" value="{% if attempt.student_id %}{{ attempt.student_id }}{% elif attempt.user %}{{ attempt.user.username }}{% endif %}">

    <div class="bg-white max-w-2xl w-full rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        
        <div class="bg-gray-50 p-6 border-b border-gray-100 text-center">
            <h1 class="text-2xl font-bold text-gray-800" x-text="step === 1 ? 'Paso 1: Rostro' : 'Paso 2: Validación DNI'"></h1>
            <p class="text-gray-500 text-sm mt-1" x-text="statusText"></p>
        </div>

        <div class="relative bg-black h-96 flex justify-center items-center overflow-hidden group">
            
            <video id="video" x-ref="video" autoplay muted playsinline class="absolute w-full h-full object-cover transition-transform duration-500" :class="step === 1 ? 'scale-x-[-1]' : ''"></video>
            
            <div x-show="step === 1" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                 <div class="relative w-64 h-64 flex items-center justify-center">
                     <div class="absolute inset-0 rounded-full border-4 transition-all duration-300"
                          :class="faceDetected ? 'border-green-400 scale-105' : 'border-white/30 border-dashed'"></div>
                     <span class="text-white font-bold bg-black/50 px-3 py-1 rounded backdrop-blur-md" 
                           x-text="faceDetected ? '¡Quieto!' : 'Ubica tu cara'"></span>
                 </div>
                 <div class="w-48 h-2 bg-gray-800 rounded-full mt-6 overflow-hidden border border-gray-600" x-show="faceDetected">
                    <div class="h-full bg-green-500 transition-all duration-100 ease-linear" :style="`width: ${progress}%`"></div>
                 </div>
            </div>

            <div x-show="step === 2 && !isSuccess" class="absolute inset-0 pointer-events-none flex flex-col items-center justify-center z-10">
                 
                 <div class="absolute bottom-4 w-full px-8 flex flex-col items-center pointer-events-auto">
                     
                     <div class="w-full max-w-md h-20 border-2 border-yellow-400 bg-yellow-400/10 rounded-lg relative flex items-center justify-center overflow-hidden mb-2">
                        <div class="opacity-50 text-white font-mono text-xs tracking-widest text-center">
                            UBICA LAS LETRAS AQUÍ<br>
                            <<<<<<<<<<<<<<<<<<<<<
                        </div>
                     </div>

                     <div class="flex gap-4 items-center bg-black/80 p-2 rounded-lg border border-gray-600">
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400">Lo que ve la IA:</p>
                            <p class="text-[10px] text-yellow-500 font-bold" x-show="isScanning">Escaneando...</p>
                        </div>
                        <canvas id="debug-canvas" width="150" height="40" class="border border-white/30 bg-gray-800"></canvas>
                     </div>
                     
                     <p class="text-white text-xs mt-2 font-mono bg-black/50 px-2 rounded" x-text="debugText">Iniciando...</p>
                 </div>
            </div>

            <div x-show="isSuccess" class="absolute inset-0 bg-green-600/95 backdrop-blur-md flex flex-col items-center justify-center z-30" x-cloak>
                <div class="bg-white p-4 rounded-full mb-4 shadow-xl animate-bounce">
                    <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-white text-2xl font-bold">¡DNI Detectado!</h3>
                <p class="text-white/80 text-sm mt-2" x-text="successDetail"></p>
            </div>

            <div x-show="isLoading" class="absolute inset-0 flex items-center justify-center bg-black/90 z-20">
                <span class="text-white text-xs">Cargando Motores...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

<script>
    function biometricScanner() {
        return {
            step: 1,
            isLoading: true,
            isScanning: false,
            isSuccess: false,
            statusText: 'Foto automática en 3, 2, 1...',
            debugText: 'Esperando imagen...',
            successDetail: '',
            expectedDNI: '',
            
            faceDetected: false,
            progress: 0,
            consecutiveFrames: 0,
            REQUIRED_FRAMES: 15, 

            capturedFace: null,
            capturedDNI: null, 
            worker: null,
            ocrInterval: null,
            
            async init() {
                this.expectedDNI = document.getElementById('expected_dni').value.trim();
                // Limpiar puntos del DNI esperado para comparar fácil (20.635 -> 20635)
                if(this.expectedDNI) this.expectedDNI = this.expectedDNI.replace(/\./g, '');

                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                try {
                    this.initTesseract();
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                    });
                    this.$refs.video.srcObject = stream;
                    this.$refs.video.onloadedmetadata = () => {
                        this.$refs.video.play();
                        this.isLoading = false;
                        this.startFaceAutoCapture(); 
                    };
                } catch(e) {
                    alert("Error crítico: No hay cámara.");
                }
            },

            async initTesseract() {
                this.worker = await Tesseract.createWorker('eng');
                // Optimizamos para que SOLO busque números y mayúsculas
                await this.worker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ<', 
                });
            },

            startFaceAutoCapture() {
                const video = this.$refs.video;
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const interval = setInterval(async () => {
                    if (this.step !== 1) { clearInterval(interval); return; }
                    try {
                        const detection = await faceapi.detectSingleFace(video, options);
                        if (detection) {
                            this.faceDetected = true;
                            this.consecutiveFrames++;
                            this.progress = Math.min((this.consecutiveFrames / this.REQUIRED_FRAMES) * 100, 100);
                            if (this.consecutiveFrames >= this.REQUIRED_FRAMES) {
                                clearInterval(interval);
                                this.captureFace();
                            }
                        } else {
                            this.faceDetected = false;
                            this.consecutiveFrames = 0;
                            this.progress = 0;
                        }
                    } catch (err) {}
                }, 100);
            },

            captureFace() {
                const video = this.$refs.video;
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                this.capturedFace = canvas.toDataURL('image/jpeg', 0.8);
                this.startOCRScanner();
            },

            startOCRScanner() {
                this.step = 2;
                this.statusText = 'Validando DNI automáticamente...';
                this.isScanning = true;
                
                // Escaneamos más rápido (cada 500ms) para atrapar el momento justo
                this.ocrInterval = setInterval(() => {
                    if (!this.isSuccess) this.performOCR();
                }, 500); 
            },

            async performOCR() {
                if (!this.worker) return;
                const video = this.$refs.video;
                
                // Canvas invisible para procesamiento
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Recortamos la parte INFERIOR (donde está el texto IDARG)
                const cropWidth = video.videoWidth * 0.8; 
                const cropHeight = video.videoHeight * 0.25; 
                const startX = video.videoWidth * 0.1;
                const startY = video.videoHeight * 0.70; // Zona baja

                canvas.width = cropWidth;
                canvas.height = cropHeight;
                
                // Dibujamos la imagen original
                ctx.drawImage(video, startX, startY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                // --- FILTRO VISUAL MEJORADO (Escala de grises + Contraste) ---
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    // Convertir a gris
                    let gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
                    
                    // Aumentar contraste radicalmente
                    // Si es gris claro -> Blanco. Si es gris oscuro -> Negro.
                    // Esto ayuda a eliminar el "ruido" de la mesa o el plástico
                    let contrast = gray > 110 ? 255 : 0; 

                    data[i] = contrast;     // R
                    data[i + 1] = contrast; // G
                    data[i + 2] = contrast; // B
                }
                ctx.putImageData(imageData, 0, 0);

                // --- MOSTRAR AL USUARIO LO QUE VE LA IA ---
                // Copiamos la imagen procesada al canvas visible "debug-canvas"
                const debugCanvas = document.getElementById('debug-canvas');
                if (debugCanvas) {
                    debugCanvas.getContext('2d').drawImage(canvas, 0, 0, debugCanvas.width, debugCanvas.height);
                }

                this.debugText = "Analizando...";
                
                try {
                    const { data: { text, confidence } } = await this.worker.recognize(canvas);
                    
                    // Limpieza total del texto
                    const cleanText = text.replace(/[^0-9A-Z]/g, ''); // Solo numeros y letras
                    
                    // ESTRATEGIA: Buscar TU DNI específico
                    // Si sabemos quién sos (expectedDNI), buscamos SOLO ese número.
                    let found = false;

                    if (this.expectedDNI && cleanText.includes(this.expectedDNI)) {
                        found = true;
                        this.successDetail = "Coincidencia exacta con DNI " + this.expectedDNI;
                    } 
                    // Si sos invitado (no tenemos DNI), buscamos patrón de DNI válido (7 u 8 números seguidos)
                    else if (!this.expectedDNI) {
                        const match = cleanText.match(/(\d{7,8})/);
                        if (match) {
                            found = true;
                            this.successDetail = "DNI Leído: " + match[0];
                        }
                    }

                    if (found) {
                        this.isSuccess = true;
                        clearInterval(this.ocrInterval);
                        
                        // Guardar foto original (a color)
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = video.videoWidth;
                        finalCanvas.height = video.videoHeight;
                        finalCanvas.getContext('2d').drawImage(video, 0, 0);
                        this.capturedDNI = finalCanvas.toDataURL('image/jpeg', 0.8);

                        this.uploadSuccess();
                    } else {
                        // Feedback para el usuario (le mostramos trozos de lo que lee para que sepa si enfoca bien)
                        if (cleanText.length > 5) {
                            this.debugText = "Veo: " + cleanText.substring(0, 10) + "...";
                        } else {
                            this.debugText = "No veo texto claro (evita reflejos)";
                        }
                    }

                } catch (err) { }
            },

            async uploadSuccess() {
                try {
                    await fetch("{% url 'runner:register_biometrics' attempt.id %}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify({
                            reference_face: this.capturedFace,
                            dni_image: this.capturedDNI,
                            metadata: { method: 'AUTO_OCR_V2' }
                        })
                    });
                    
                    setTimeout(() => {
                         window.location.href = "{% url 'runner:exam_runner' exam.access_code attempt.id %}";
                    }, 1000);
                    
                } catch (err) {
                    alert("Error de conexión.");
                    window.location.reload();
                }
            }
        }
    }
</script>
{% endblock %}
