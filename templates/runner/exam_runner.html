<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rindiendo: {{ exam.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        .timer-bar { transition: width 1s linear; }
        .read-only-mode { opacity: 0.8; pointer-events: none; background-color: #f3f4f6; border-color: #fb923c; }
        .blur-content { filter: blur(8px); pointer-events: none; user-select: none; }
        .modal-enter { animation: modal-in 0.3s ease-out forwards; }
        @keyframes modal-in {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden select-none bg-gray-50" 
      x-data="examRunner({
          attemptId: '{{ attempt.id }}',
          serverRemaining: {{ remaining_seconds }},
          timePerItem: {{ time_per_item }},
          totalQuestions: {{ total_questions }},
          initialStep: {{ initial_step|default:0 }},
          csrfToken: '{{ csrf_token }}'
      })"
      x-init="init()">

    <video x-ref="webcam" id="webcam-video" autoplay playsinline muted class="fixed bottom-4 right-4 w-32 h-24 object-cover rounded-lg shadow-lg border-2 border-gray-800 z-50 opacity-80 pointer-events-none transform scale-x-[-1]"></video>

    <div x-show="!isFullScreen && !isSubmitting" 
         class="fixed inset-0 z-[60] bg-white/90 backdrop-blur-md flex flex-col items-center justify-center text-center p-6 transition-opacity duration-300"
         x-cloak>
        
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full border border-gray-100 modal-enter relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-600"></div>

            <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
            </div>
            
            <h2 class="text-3xl font-extrabold text-gray-900 mb-3 tracking-tight">Modo Examen Seguro</h2>
            <p class="text-gray-500 mb-8 text-lg leading-relaxed">
                Para garantizar la validez de tu intento, el examen debe realizarse en <b>Pantalla Completa</b>.
            </p>
            
            <button @click="enableFullscreen()" 
                    class="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg rounded-xl shadow-lg shadow-indigo-200 transform transition hover:-translate-y-1 active:scale-95">
                Comenzar / Continuar
            </button>
            
            <p class="mt-4 text-xs text-gray-400">Si se cierra la pantalla completa, se registrará un incidente.</p>
        </div>
    </div>

    <div x-show="showConfirmModal" 
         class="fixed inset-0 z-[70] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4"
         x-cloak>
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center modal-enter">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">¿Finalizar Examen?</h3>
            <p class="text-gray-500 mb-6">Confirma que has respondido todo.<br>Esta acción <b>no se puede deshacer</b>.</p>
            
            <div class="flex gap-3">
                <button @click="showConfirmModal = false" 
                        class="flex-1 py-3 px-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">
                    Volver
                </button>
                <button @click="submitForm()" 
                        class="flex-1 py-3 px-4 bg-gray-900 text-white font-bold rounded-xl hover:bg-black transition-colors shadow-lg">
                    Entregar
                </button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full transition-all duration-500"
         :class="!isFullScreen ? 'blur-md scale-[0.98] grayscale-[0.5]' : ''">

        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 sm:px-6 z-10 shrink-0 shadow-sm">
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-bold text-gray-800 truncate max-w-xs hidden sm:block">{{ exam.title }}</h1>
                
                <span class="px-2 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded border border-indigo-100">
                    P <span x-text="currentStep + 1"></span>/<span x-text="total"></span>
                </span>
                
                <div class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-colors"
                     :class="aiStatus === 'ok' ? 'bg-green-100 text-green-700' : (aiStatus === 'warning' ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700')">
                    <span class="relative flex h-2 w-2">
                      <span x-show="aiStatus === 'ok'" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2" 
                            :class="aiStatus === 'ok' ? 'bg-green-500' : (aiStatus === 'warning' ? 'bg-orange-500' : 'bg-red-500')"></span>
                    </span>
                    <span x-text="aiMessage">Monitor Activo</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-xs font-medium transition-colors duration-300 hidden sm:block"
                     :class="saveStatus === 'saving' ? 'text-blue-500' : (saveStatus === 'saved' ? 'text-green-500' : 'text-red-500')">
                    <span x-show="saveStatus === 'saving'">Guardando...</span>
                    <span x-show="saveStatus === 'saved'">Guardado</span>
                    <span x-show="saveStatus === 'error'">Error al guardar</span>
                </div>

                <div class="h-6 w-px bg-gray-300 mx-2 hidden sm:block"></div>

                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Tiempo Total</span>
                    <div class="font-mono text-xl font-bold text-gray-700 leading-none"
                         :class="globalSeconds < 300 ? 'text-red-600 animate-pulse' : ''">
                         <span x-text="formatTime(globalSeconds)"></span>
                    </div>
                </div>

                <a href="#" @click.prevent="finishExam()" 
                   class="bg-gray-900 hover:bg-black text-white text-sm font-bold py-2 px-4 rounded transition-colors shadow-sm ml-2">
                    Entregar
                </a>
            </div>
        </header>

        <div class="w-full bg-gray-200 h-1.5 relative">
            <div class="bg-blue-600 h-1.5 timer-bar absolute top-0 left-0 transition-all duration-1000 ease-linear" 
                 :style="'width: ' + itemProgress + '%'"></div>
        </div>

        <main class="flex-1 overflow-y-auto p-4 sm:p-8 flex justify-center bg-gray-50">
            <div class="w-full max-w-3xl space-y-6">
                
                <form id="examForm" method="POST" action="{% url 'runner:submit_exam' attempt.id %}">
                    {% csrf_token %}
                    
                    {% for item in items %}
                    <div x-show="currentStep === {{ forloop.counter0 }}" x-cloak
                         class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-8 relative"
                         :class="currentStep < initialStep ? 'read-only-mode' : ''">
                        
                        <div class="absolute top-4 right-4 flex items-center gap-1 text-xs font-mono text-gray-500 border rounded px-2 py-1 bg-gray-50">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span x-text="itemSeconds"></span>s
                        </div>

                        <div x-show="currentStep < initialStep" class="mb-4 p-2 bg-orange-100 text-orange-700 text-xs font-bold rounded flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            Pregunta bloqueada (Tiempo agotado o ya respondida)
                        </div>

                        <div class="mb-6 mt-2">
                            <h2 class="text-xl font-medium text-gray-900 leading-relaxed">{{ item.stem|linebreaksbr }}</h2>
                        </div>

                        <div class="space-y-3">
                            {% for opt in item.options %}
                            <label class="flex items-start p-4 rounded-xl border cursor-pointer transition-all group"
                                   :class="answers['{{ item.id }}'] === '{{ opt.text|escapejs }}' ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' : 'border-gray-200 hover:border-indigo-300 hover:bg-gray-50'">
                                
                                <input type="radio" 
                                       name="q_{{ item.id }}" 
                                       value="{{ opt.text }}" 
                                       :disabled="currentStep < initialStep"
                                       @change="saveAnswer('{{ item.id }}', '{{ opt.text|escapejs }}')"
                                       class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                
                                <span class="ml-3 text-gray-700 group-hover:text-indigo-900 font-medium select-text">{{ opt.text }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </form>

            </div>
        </main>

        <footer class="bg-white border-t border-gray-200 h-20 flex items-center justify-center px-6 shrink-0">
            <div class="w-full max-w-3xl flex justify-between items-center">
                <div class="w-24"></div>

                <button @click="nextQuestion()" x-show="currentStep < total - 1"
                        class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 flex items-center gap-2 transform hover:-translate-y-0.5">
                    Siguiente Pregunta
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                </button>

                <button x-show="currentStep === total - 1" x-cloak
                        @click="finishExam()"
                        class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition-colors shadow-lg shadow-green-200 transform hover:-translate-y-0.5">
                    Finalizar Examen
                </button>
            </div>
        </footer>
    </div>

   <script>
        function examRunner(config) {
            return {
                // Configuración
                attemptId: config.attemptId,
                csrfToken: config.csrfToken,
                
                // Estado del Examen
                total: config.totalQuestions,
                currentStep: config.initialStep,
                initialStep: config.initialStep,
                answers: {{ attempt.answers|safe|default:"{}" }}, 
                saveStatus: '', 
                isFullScreen: false,
                
                // Estado de Modales
                isSubmitting: false, 
                showConfirmModal: false, 
                
                // Tiempos
                globalSeconds: config.serverRemaining,
                itemSeconds: config.timePerItem,
                maxItemSeconds: config.timePerItem,
                itemProgress: 100,

                // Estado de IA
                aiStatus: 'loading', 
                aiMessage: 'Iniciando Monitor...',
                anchorDescriptor: null,
                isUploadingEvidence: false, // Control para no saturar subidas

                init() {
                    this.startTimers();
                    this.startProctoring().then(() => {
                        this.setupSecurity(); 
                    });
                },

                startTimers() {
                    setInterval(() => {
                        if (this.globalSeconds > 0) {
                            this.globalSeconds--;
                        } else {
                            this.submitForm();
                        }
                    }, 1000);

                    setInterval(() => {
                        if (this.currentStep < this.total && this.currentStep >= this.initialStep) { 
                            if (this.itemSeconds > 0) {
                                this.itemSeconds--;
                                this.itemProgress = (this.itemSeconds / this.maxItemSeconds) * 100;
                            } else {
                                this.nextQuestion(true); 
                            }
                        }
                    }, 1000);
                },

                // --- PROCTORING (FACE API) ---
                async startProctoring() {
                    try {
                        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                        ]);

                        const stored = localStorage.getItem('exam_anchor_descriptor');
                        if (stored) this.anchorDescriptor = new Float32Array(JSON.parse(stored));

                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { width: 320, height: 240, facingMode: "user" } 
                        });
                        this.$refs.webcam.srcObject = stream;

                        this.aiStatus = 'ok';
                        this.aiMessage = 'Monitor Activo';
                        this.detectLoop();

                    } catch (e) {
                        console.error("Error iniciando proctoring:", e);
                        this.aiStatus = 'error';
                        this.aiMessage = 'Error de Cámara';
                        this.logRiskEventWithEvidence('CAMERA_ERROR', e.toString());
                    }
                },

                async detectLoop() {
                    const video = this.$refs.webcam;
                    if (!video.paused && !video.ended) {
                        try {
                            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                            const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();

                            if (detection) {
                                this.aiStatus = 'ok';
                                this.aiMessage = 'Monitor Activo';

                                if (this.anchorDescriptor) {
                                    const distance = faceapi.euclideanDistance(this.anchorDescriptor, detection.descriptor);
                                    if (distance > 0.6) {
                                        this.aiStatus = 'warning';
                                        this.aiMessage = 'Identidad dudosa';
                                        // EVIDENCIA DE ROSTRO
                                        this.logRiskEventWithEvidence('IDENTITY_MISMATCH', 'Rostro no coincide (Distancia: ' + distance.toFixed(2) + ')');
                                    }
                                }
                            } else {
                                this.aiStatus = 'warning';
                                this.aiMessage = 'Rostro no visible';
                                // EVIDENCIA DE ROSTRO
                                this.logRiskEventWithEvidence('NO_FACE', 'Rostro no detectado en cámara');
                            }
                        } catch (err) {}
                    }
                    setTimeout(() => this.detectLoop(), 1000);
                },

                // --- FUNCIÓN INTELIGENTE DE EVIDENCIA (Screenshot vs Webcam) ---
                async logRiskEventWithEvidence(type, reason) {
                    if (this.isSubmitting) return; 
                    if (this.isUploadingEvidence) return; 
                    
                    this.isUploadingEvidence = true;
                    let imageBase64 = null;

                    try {
                        // --- CASO A: EVIDENCIA DE PANTALLA (Focus/Fullscreen) ---
                        // "Si el alumno se va, sacamos foto de qué pregunta estaba viendo"
                        if (type === 'FOCUS_LOST' || type === 'FULLSCREEN_EXIT') {
                            
                            // Ocultamos la webcam flotante para que no salga en la captura
                            const webcamEl = document.getElementById('webcam-video');
                            if(webcamEl) webcamEl.style.opacity = '0';

                            // Captura del examen (Contexto)
                            const canvas = await html2canvas(document.body, {
                                useCORS: true,
                                ignoreElements: (el) => el.id === 'webcam-video',
                                scale: 0.7, // Calidad media para rapidez
                                windowWidth: document.body.scrollWidth,
                                windowHeight: document.body.scrollHeight
                            });
                            
                            // Restauramos webcam
                            if(webcamEl) webcamEl.style.opacity = '0.8';
                            
                            imageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        } 
                        
                        // --- CASO B: EVIDENCIA DE ROSTRO (Identidad) ---
                        else {
                            const video = this.$refs.webcam;
                            if (video && video.readyState === 4) {
                                const canvas = document.createElement('canvas');
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                imageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                            }
                        }

                        // Enviar al Backend
                        await fetch("{% url 'runner:log_event' attempt.id %}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken },
                            body: JSON.stringify({
                                event_type: type,
                                metadata: { reason: reason },
                                image: imageBase64 // Enviamos la evidencia generada
                            })
                        });
                        console.log("Evidencia registrada para:", type);

                    } catch (e) {
                        console.error("Error generando evidencia", e);
                    } finally {
                        // Espera corta (1.5s) para capturar ráfagas de eventos
                        setTimeout(() => { this.isUploadingEvidence = false; }, 1500);
                    }
                },

                // --- FUNCIÓN LOG SIMPLE (SIN FOTO, PARA RETORNO) ---
                async logEvent(type, meta = {}) {
                    if (this.isSubmitting) return;
                    try { 
                        await fetch("{% url 'runner:log_event' attempt.id %}", { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken }, 
                            body: JSON.stringify({ event_type: type, metadata: meta }) 
                        }); 
                    } catch (e) {}
                },

                // --- SEGURIDAD Y LOGS (ACTUALIZADO) ---
                setupSecurity() {
                    // Ahora TODOS los eventos de riesgo usan logRiskEventWithEvidence (con foto)
                    
                    document.addEventListener("visibilitychange", () => {
                        if (document.hidden) {
                            this.logRiskEventWithEvidence('FOCUS_LOST', 'Pestaña oculta / Cambio de aplicación');
                        } else {
                            // SI VUELVE, LOGUEAMOS FOCUS_GAINED (SIN FOTO) PARA CALCULAR TIEMPO
                            this.logEvent('FOCUS_GAINED', { status: 'returned' });
                        }
                    });
                    
                    window.addEventListener("blur", () => {
                        this.logRiskEventWithEvidence('FOCUS_LOST', 'Foco de ventana perdido (Clic fuera)');
                    });

                    window.addEventListener("focus", () => {
                        this.logEvent('FOCUS_GAINED', { status: 'focus_restored' });
                    });
                    
                    document.addEventListener('fullscreenchange', () => {
                        this.isFullScreen = !!document.fullscreenElement;
                        if (!this.isFullScreen && !this.isSubmitting) {
                            this.logRiskEventWithEvidence('FULLSCREEN_EXIT', 'Salida de Pantalla Completa');
                        }
                    });
                    this.isFullScreen = !!document.fullscreenElement;
                },

                // --- NAVEGACIÓN Y GUARDADO ---
                nextQuestion(auto = false) {
                    if (this.currentStep < this.total - 1) {
                        if (this.currentStep === this.initialStep) this.initialStep++;
                        this.currentStep++;
                        this.itemSeconds = this.maxItemSeconds;
                        this.itemProgress = 100;
                        document.querySelector('main').scrollTo({top: 0, behavior: 'smooth'});
                    } else if (auto) {
                        this.finishExam();
                    }
                },

                async saveAnswer(questionId, answer) {
                    if (this.currentStep < this.initialStep) return;
                    this.answers[questionId] = answer;
                    this.saveStatus = 'saving';
                    try {
                        const response = await fetch("{% url 'runner:save_answer' attempt.id %}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken },
                            body: JSON.stringify({ question_id: questionId, answer: answer })
                        });
                        if (response.ok) {
                            setTimeout(() => this.saveStatus = 'saved', 500);
                        } else {
                            this.saveStatus = 'error';
                        }
                    } catch (error) { this.saveStatus = 'error'; }
                },

                finishExam() { this.showConfirmModal = true; },

                submitForm() {
                    this.isSubmitting = true; 
                    this.showConfirmModal = false;
                    document.getElementById('examForm').submit();
                },

                enableFullscreen() {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => alert("Por favor presiona F11"));
                    }
                },

                formatTime(seconds) {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = seconds % 60;
                    return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` 
                                 : `${m}:${s.toString().padStart(2, '0')}`;
                }
            }
        }
    </script>
</body>
</html>
